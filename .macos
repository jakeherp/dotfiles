#!/usr/bin/env bash
set -euo pipefail

# Close settings UI (name changed years ago; keep both for compatibility)
osascript -e 'tell application "System Settings" to quit' >/dev/null 2>&1 || true
osascript -e 'tell application "System Preferences" to quit' >/dev/null 2>&1 || true

# Ask for admin upfront
sudo -v

# Keep sudo alive
while true; do
	sudo -n true
	sleep 60
	kill -0 "$$" || exit
done 2>/dev/null &

echo "Hello $(whoami)! Let's get you set up."

mkdir -p "${HOME}/code"

###############################################################################
# Homebrew
###############################################################################
if ! command -v brew >/dev/null 2>&1; then
	echo "Installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# shellenv for both Apple Silicon + Intel
if [[ -x /opt/homebrew/bin/brew ]]; then
	eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
	eval "$(/usr/local/bin/brew shellenv)"
fi

# Persist brew shellenv (avoid hardcoding username/path)
if ! grep -q 'brew shellenv' "${HOME}/.zprofile" 2>/dev/null; then
	if [[ -x /opt/homebrew/bin/brew ]]; then
		echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> "${HOME}/.zprofile"
	elif [[ -x /usr/local/bin/brew ]]; then
		echo 'eval "$(/usr/local/bin/brew shellenv)"' >> "${HOME}/.zprofile"
	fi
fi

brew update

###############################################################################
# CLI tooling (trimmed; add more as you actually need them)
###############################################################################
brew install \
	git git-delta gh ripgrep tree bat watchman imagemagick \
	pgcli \
	nvm \
	mas \
	ollama

###############################################################################
# Node via nvm (modern LTS)
###############################################################################
export NVM_DIR="${HOME}/.nvm"
mkdir -p "${NVM_DIR}"

# Load nvm in this shell (brew installs nvm but doesn’t auto-source it)
if [[ -s "$(brew --prefix nvm)/nvm.sh" ]]; then
	# shellcheck disable=SC1090
	source "$(brew --prefix nvm)/nvm.sh"
fi

nvm install --lts
nvm alias default 'lts/*'

echo "node: $(node --version)"
echo "npm:  $(npm --version)"

###############################################################################
# Apps
###############################################################################
brew install --cask \
	1password \
	1password-cli \
	affinity \
	arc \
	audacity \
	balenaetcher \
	bartender \
	cursor \
  cursor-cli \
	discord \
	docker \
	figma \
	ghostty \
	google-chrome \
	grammarly-desktop \
	insomnia \
	istat-menus \
	karabiner-elements \
  kiro-cli \
	microsoft-excel \
	microsoft-powerpoint \
	microsoft-outlook \
	microsoft-word \
	microsoft-teams \
	nordvpn \
	notion \
	pgadmin4 \
	raycast \
	signal \
	slack \
	tailscale-app \
	vlc \
	warp \
	whatsapp \
	zed \
	zen \
	zoom

# Dev tooling
brew install \
	atuin \
	lsd \
	python@3 \
	pyenv \
	go \
	rust

# pyenv bootstrap (zsh)
if ! grep -q 'pyenv init' "${HOME}/.zprofile" 2>/dev/null; then
	cat >> "${HOME}/.zprofile" <<'EOF'

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
export PATH="$PYENV_ROOT/bin:$PATH"
eval "$(pyenv init -)"
EOF
fi

# Load pyenv for this run
export PYENV_ROOT="${HOME}/.pyenv"
export PATH="${PYENV_ROOT}/bin:${PATH}"
eval "$(pyenv init -)" || true

# Ensure a Python 3 via pyenv (pick latest available in your pyenv build list)
PYENV_LATEST_PY3="$(pyenv install -l | sed 's/^[[:space:]]*//' | grep -E '^3\.[0-9]+\.[0-9]+$' | tail -1)"
pyenv install -s "${PYENV_LATEST_PY3}"
pyenv global "${PYENV_LATEST_PY3}"

# Sanity checks
python3 --version
pyenv --version
go version
rustc --version
cargo --version

# Kiro CLI autocomplete is enabled by default; enforce it (safe to re-run)
kiro-cli settings autocomplete.disable false || true
kiro-cli inline enable || true

atuin --version
lsd --version
kiro-cli --version

###############################################################################
# SSH key (modern keychain flags; replaces ssh-add -K)
###############################################################################
if [[ ! -f "${HOME}/.ssh/id_ed25519" ]]; then
	echo "Generating a new SSH key..."
	mkdir -p "${HOME}/.ssh"
	ssh-keygen -t ed25519 -C "jacob@herper.uk" -f "${HOME}/.ssh/id_ed25519"
fi

touch "${HOME}/.ssh/config"
if ! grep -q 'AddKeysToAgent' "${HOME}/.ssh/config"; then
	cat >> "${HOME}/.ssh/config" <<'EOF'

Host *
	AddKeysToAgent yes
	UseKeychain yes
	IdentityFile ~/.ssh/id_ed25519
EOF
fi

eval "$(ssh-agent -s)" >/dev/null
ssh-add --apple-use-keychain "${HOME}/.ssh/id_ed25519" >/dev/null 2>&1 || true
echo "Run: pbcopy < ~/.ssh/id_ed25519.pub  (then add it to GitHub / Gitlab)"

###############################################################################
# Dotfiles
###############################################################################
if [[ ! -d "${HOME}/dotfiles" ]]; then
	git clone git@github.com:jakeherp/dotfiles.git "${HOME}/dotfiles"
fi

ln -sf "${HOME}/dotfiles/.zshrc" "${HOME}/.zshrc"
ln -sf "${HOME}/dotfiles/.gitignore" "${HOME}/.gitignore_global"
ln -sf "${HOME}/dotfiles/.gitconfig" "${HOME}/.gitconfig"

###############################################################################
# Cursor extensions
###############################################################################

# Resolve Cursor CLI binary (varies by install / first launch)
CURSOR_BIN=""

if command -v cursor-cli >/dev/null 2>&1; then
	CURSOR_BIN="cursor-cli"
elif command -v cursor >/dev/null 2>&1; then
	CURSOR_BIN="cursor"
fi

if [[ -n "${CURSOR_BIN}" ]]; then
	echo "Installing Cursor extensions using ${CURSOR_BIN}..."

	extensions=(
		aaron-bond.better-comments
		anysphere.cursorpyright
		astro-build.astro-vscode
		biomejs.biome
		bradlc.vscode-tailwindcss
		cardinal90.multi-cursor-case-preserve
		christian-kohler.path-intellisense
		davidanson.vscode-markdownlint
		dbaeumer.vscode-eslint
		eamodio.gitlens
		esbenp.prettier-vscode
		fivethree.vscode-svelte-snippets
		formulahendry.auto-rename-tag
		graphql.vscode-graphql
		graphql.vscode-graphql-syntax
		mikestead.dotenv
		ms-python.python
		ms-python.debugpy
		ms-vscode.makefile-tools
		pflannery.vscode-versionlens
		shd101wyy.markdown-preview-enhanced
		statelyai.stately-vscode
		streetsidesoftware.code-spell-checker
		styled-components.vscode-styled-components
		svelte.svelte-vscode
		tyriar.sort-lines
		unifiedjs.vscode-mdx
		usernamehw.errorlens
		wakatime.vscode-wakatime
	)

	for ext in "${extensions[@]}"; do
		"${CURSOR_BIN}" --install-extension "$ext" >/dev/null 2>&1 || true
	done
else
	echo "Cursor CLI not found."
	echo "Open Cursor once to register the CLI, then re-run this section."
fi

###############################################################################
# macOS defaults (kept to stuff that still tends to stick)
###############################################################################

# Expand save/print panels by default
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode -bool true
defaults write NSGlobalDomain NSNavPanelExpandedStateForSaveMode2 -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint -bool true
defaults write NSGlobalDomain PMPrintingExpandedStateForPrint2 -bool true

# Printer app quits after jobs complete
defaults write com.apple.print.PrintingPrefs "Quit When Finished" -bool true

# Keyboard/text input (coding-friendly)
defaults write NSGlobalDomain NSAutomaticCapitalizationEnabled -bool false
defaults write NSGlobalDomain NSAutomaticDashSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticPeriodSubstitutionEnabled -bool false
defaults write NSGlobalDomain NSAutomaticQuoteSubstitutionEnabled -bool false
defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false

# Key repeat (tweak if too aggressive)
defaults write NSGlobalDomain KeyRepeat -int 1
defaults write NSGlobalDomain InitialKeyRepeat -int 10

# Trackpad: tap-to-click
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults -currentHost write NSGlobalDomain com.apple.mouse.tapBehavior -int 1
defaults write NSGlobalDomain com.apple.mouse.tapBehavior -int 1

# Trackpad: three-finger drag (correct domains)
defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -int 1
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -int 1

# Screenshots
defaults write com.apple.screencapture location -string "${HOME}/Desktop"
defaults write com.apple.screencapture type -string "png"

# Finder
defaults write com.apple.finder QuitMenuItem -bool true
defaults write com.apple.finder AppleShowAllFiles -bool true
defaults write NSGlobalDomain AppleShowAllExtensions -bool true
defaults write com.apple.finder ShowStatusBar -bool true
defaults write com.apple.finder _FXShowPosixPathInTitle -bool true
defaults write com.apple.finder _FXSortFoldersFirst -bool true
defaults write com.apple.finder FXDefaultSearchScope -string "SCcf"
defaults write com.apple.finder FXEnableExtensionChangeWarning -bool false
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool true
defaults write com.apple.desktopservices DSDontWriteUSBStores -bool true

# Finder: icon view prefs via PlistBuddy can still work but is brittle; keep only if you really care
# /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy grid" ~/Library/Preferences/com.apple.finder.plist || true

# Dock
defaults write com.apple.dock minimize-to-application -bool true
defaults write com.apple.dock show-process-indicators -bool true
defaults write com.apple.dock showhidden -bool true
defaults write com.apple.dock static-only -bool true

# OPTIONAL (explicit opt-in): disable “downloaded app” quarantine warnings
# defaults write com.apple.LaunchServices LSQuarantine -bool false

###############################################################################
# Restart affected apps
###############################################################################
for app in "cfprefsd" "Dock" "Finder" "SystemUIServer"; do
	killall "${app}" >/dev/null 2>&1 || true
done

echo "Done. Some changes may require logout/restart."
printf "TODO:\n- Sign into App Store (for Flighty/mas)\n- Login to apps\n"
